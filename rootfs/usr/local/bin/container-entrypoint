#!/bin/sh
# shellcheck shell=dash
set -euo pipefail
# shellcheck disable=SC2154
if [ -n "${DEBUG+x}" ]; then
    set -x
fi

export PATH='/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'
readonly iface="${IFACE:-$(ip -4 route show 0/0 | awk '{ print $5 }')}"

if [ -n "$(ip -4 route | head -c 1)" ]; then
    if [ -z "$(iptables-save | head -c 1)" ]; then
        iptables-restore '/etc/iptables/default-policy'
        iptables-restore -n '/etc/iptables/ipv4-default'
    fi

    { grep -E '^-(A|I) ' '/etc/iptables/ipv4-custom' || :; } \
    | sed "s/{IFACE}/${iface}/g" \
    | while read -r rule; do
        check=$(printf '%s' "${rule}" | sed -E 's/^-.( \S+)( \d+)?(.+)/-C\1\3/')
        # shellcheck disable=SC2086
        iptables ${check} 2> '/dev/null' || iptables ${rule}
    done
fi

if [ -n "$(ip -6 route | head -c 1)" ]; then
    if [ -z "$(ip6tables-save | head -c 1)" ]; then
        ip6tables-restore '/etc/iptables/default-policy'
    fi
fi

if [ "$1" = 'container-daemon' ]; then
    set -- sh
fi

exec "$@"
