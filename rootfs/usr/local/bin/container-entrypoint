#!/bin/sh
if [ -n "${DEBUG}" ]; then
    set -x
fi

if '/sbin/ip' -4 route | '/bin/grep' -q $; then
    if ! '/sbin/iptables-save' | '/bin/grep' -qE '^\:ICMP\-'; then
        if ! '/sbin/iptables-restore' '/etc/iptables/default-policy'; then
            exit 1
        fi

        if ! '/sbin/iptables-restore' -n '/etc/iptables/ipv4-default'; then
            exit 1
        fi
    fi

    if ! '/sbin/iptables-restore' -n '/etc/iptables/ipv4-custom'; then
        exit 1
    fi
fi

if '/sbin/ip' -6 route | '/bin/grep' -q $; then
    if ! '/sbin/ip6tables-save' | '/bin/grep' -qE '^\-'; then
        if ! '/sbin/ip6tables-restore' '/etc/iptables/default-policy'; then
            exit 1
        fi
    fi
fi

if [ "$1" == 'container-daemon' ]; then
    set -- '/bin/sh'
fi

exec "$@"
